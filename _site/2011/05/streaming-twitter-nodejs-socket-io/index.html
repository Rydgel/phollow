<!doctype html>
<html class="no-js" lang="fr" dir="ltr" itemscope itemtype="http://schema.org/Article" xmlns="http://www.w3.org/1999/xhtml" xmlns:og="http://ogp.me/ns#" xmlns:fb="http://www.facebook.com/2008/fbml">
<head id="phollow-fr" data-template-set="html5-phollow-wordpress-theme" profile="http://purl.org/uF/hAtom/0.1/ http://purl.org/uF/2008/03/" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# phollow: http://ogp.me/ns/fb/phollow#">
  <meta charset="UTF-8">
  <title>Streaming Twitter: NodeJS & Socket.IO</title>
  <link href="https://plus.google.com/116513653525162928064" rel="publisher">
  <meta name="title" content="Streaming Twitter: NodeJS & Socket.IO">
  <meta name="author" content="Jérôme Mahuet">
  <meta name="Copyright" content="Copyright Jérôme Mahuet 2012. All Rights Reserved.">
  <meta name="google-site-verification" content="b3k5NRe5t9U-Pk1_CK_g5oN0U12YXuc55rUQWCHgbZY">
  <meta property="og:title" content="Streaming Twitter: NodeJS & Socket.IO">
  <meta property="og:type" content="phollow:post">
  <meta property="og:site_name" content="Phollow.me">
  <meta property="fb:admins" content="rydgel">
  <meta property="fb:app_id" content="101739241646">
  <meta itemprop="name" content="Streaming Twitter: NodeJS & Socket.IO"> 
  <meta http-equiv="cleartype" content="on">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <link rel="stylesheet" href="/css/compiled/global.css?v=4">
  <link rel="alternate" type="application/atom+xml" title="Atom 0.3" href="/atom.xml">
  <script src="/js/compiled/modernizr.min.js"></script>
  <script>
  WebFontConfig = {
    fontdeck: {
      id: '19429'
    }
  };

  (function() {
    var wf = document.createElement('script');
    wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +   
    '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
    wf.type = 'text/javascript';
    wf.async = 'true';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(wf, s);
  })();
  </script>
</head>
<body>
  <div class="container" role="wrapper">  
    <header role="banner" id="header-site" class="sixteen columns">
      <h1 id="logo" class="four columns alpha">
        <a href="/" title="Phollow.me">Phollow.me</a>
      </h1>
      <nav id="nav-header" class="twelve columns omega">
        <ul>
          <li><a title="Phollow Archives" href="/archives/">Archives</a></li>
          <li><a target="_blank" title="about" href="http://jrm.li">Myself</a></li>
          <li><a target="_blank" title="@phollow" href="http://twitter.com/@phollow">Twitter</a></li>
          <li><a target="_blank" title="Phollow.fr RSS Feed" href="http://feeds2.feedburner.com/phollow/iuEO" target="_blank">RSS feed</a></li>
        </ul>
      </nav>
      <hr style="border-bottom: 1px solid rgba(0, 0, 0, 0.02);">
    </header>

<div id="container" class="twelve columns offset-by-four">
	<article class="post">
      <header>
		<h2 class="entry-title entry-single"><a href="/2011/05/streaming-twitter-nodejs-socket-io">Streaming Twitter: NodeJS & Socket.IO</a></h2>
		<cite class="entry-meta"><time datetime="2011-05-15 20:48:38 +0200" pubdate class="updated">May 15, 2011</time>  •  <a href="/category/bout de codes" rel="category tag">bout de codes</a>, <a href="/category/web" rel="category tag">web</a>  •  </cite>   
      </header>	
			<div class="entry single-page">
				<img class="alignnone size-full wp-image-3324" title="nodejs" src="http://s3-eu-west-1.amazonaws.com/phollow/2011/05/nodejs.jpg" alt="" width="537" height="300" />
<br>
<p style="text-align: justify;">Bonjour les enfants. Aujourd'hui on va s'amuser un peu avec <a title="Node.js" href="http://nodejs.org/" target="_blank">Node.js</a> et les Web Sockets. Pour ceux qui vivent encore dans une grotte, <strong>Node.js</strong> est un framework Javascript côté serveur basé sur <strong>V8</strong> (Chrome). L'avantage est qu'il gère les entrées/sorties de manière asynchrone et supporte un modèle de programmation événementiel. En gros il est parfait pour les applications web temps réels (notifications, push serveur, streaming…).</p>
<p style="text-align: justify;">En quelques lignes de codes on va être capable de faire cette <a title="Twitter streaming - Node.js - Socket.io" href="http://phollow.fr/tweet-stream/tweets.html" target="_blank">petite démo</a>. Tu as besoin d'avoir un navigateur <em>à la pointe de la technologie</em> pour que ça marche mon ami.</p>

<h1 style="text-align: justify;">Installation</h1>
<p style="text-align: justify;">Pour commencer il nous faut Node.js bien sur. Alors là tu as plusieurs solutions. Tu peux déjà commencer par <a title="Node.js installing manager" href="https://github.com/joyent/node/wiki/Installing-Node.js-via-package-manager" target="_blank">regarder</a> si il est disponible sous forme de paquet dans ton OS ou distribution GNU/Linux. Sinon tu vas devoir le compiler, mais c'est pas très difficile: <a href="https://github.com/joyent/node/wiki/Installation" target="_blank">regarde</a>.</p>
<p style="text-align: justify;">Il est aussi important d'installer <strong>npm</strong> (Node Package Manager), il va nous simplifier la vie quand on voudra installer des extensions à Node.js.</p>
<div class="highlight"><pre><code class="sh">curl http://npmjs.org/install.sh | sh
</code></pre>
</div>

<h1 style="text-align: justify;">Socket.io</h1>
<p style="text-align: justify;"><img class="alignnone size-full wp-image-3340" title="socket" src="http://s3-eu-west-1.amazonaws.com/phollow/2011/05/socket.jpg" alt="" width="537" height="260" /></p>
<p style="text-align: justify;"><a href="http://socket.io/" target="_blank">Socket.io</a> est la première extension que l'on va installer pour ce tutorial. Le but de cette librairie est de faciliter le développement d'applications web temps réel dans tous les navigateurs. Parce que tu as certains navigateurs qui gèrent les sockets et d'autres non. Alors cette librairie va décider elle-même quel chemin prendre pour tes échanges parmi ceux-là :</p>

<ul>
	<li>Websocket</li>
	<li>Adobe Flash $ocket ©</li>
	<li>Ajax long polling</li>
	<li>Multipart XHR</li>
	<li>Forever iFrame (lol IE)</li>
	<li>JSONP polling</li>
</ul>
<div class="highlight"><pre><code class="sh">npm install socket.io
</code></pre>
</div>

<p style="text-align: justify;">Et puisque l'on va jouer avec l'API streaming de Twitter, tu peux aussi installer l'excellent <a href="https://github.com/technoweenie/twitter-node" target="_blank">twitter-node</a> de la même manière.</p>

<h1 style="text-align: justify;">Code serveur</h1>
<div class="highlight"><pre><code class="js"><span class="kd">var</span> <span class="nx">config</span>      <span class="o">=</span> <span class="p">{</span><span class="nx">user</span><span class="o">:</span> <span class="s2">&quot;pseudo&quot;</span><span class="p">,</span> <span class="nx">password</span><span class="o">:</span> <span class="s2">&quot;password&quot;</span><span class="p">,</span> <span class="nx">action</span><span class="o">:</span> <span class="s2">&quot;filter&quot;</span><span class="p">,</span> <span class="nx">track</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;bieber&#39;</span><span class="p">]},</span>
<span class="nx">sys</span>         <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;sys&#39;</span><span class="p">),</span>
<span class="nx">server</span>      <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">).</span><span class="nx">createServer</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
<span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;text/html&#39;</span><span class="p">});</span>
<span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s1">&#39;</span>
<span class="s1">&lt;h1&gt;Twitter live stream&lt;/h1&gt;</span>
<span class="s1">&#39;</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">8080</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Server running at http://127.0.0.1:8080/&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">socket</span>      <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;socket.io&#39;</span><span class="p">).</span><span class="nx">listen</span><span class="p">(</span><span class="nx">server</span><span class="p">),</span>
<span class="nx">twitter</span>     <span class="o">=</span> <span class="k">new</span> <span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;twitter-node&quot;</span><span class="p">).</span><span class="nx">TwitterNode</span><span class="p">)(</span><span class="nx">config</span><span class="p">);</span>

<span class="nx">twitter</span>
<span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
<span class="p">})</span>
<span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="s1">&#39;tweet&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">tweet</span><span class="p">){</span>
<span class="nx">socket</span><span class="p">.</span><span class="nx">broadcast</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">tweet</span><span class="p">));</span>
<span class="p">})</span>
<span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="s1">&#39;limit&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">limit</span><span class="p">){</span>
<span class="nx">sys</span><span class="p">.</span><span class="nx">puts</span><span class="p">(</span><span class="s1">&#39;LIMIT: &#39;</span> <span class="o">+</span> <span class="nx">sys</span><span class="p">.</span><span class="nx">inspect</span><span class="p">(</span><span class="nx">limit</span><span class="p">));</span>
<span class="p">})</span>
<span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="s1">&#39;delete&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">del</span><span class="p">){</span>
<span class="nx">sys</span><span class="p">.</span><span class="nx">puts</span><span class="p">(</span><span class="s1">&#39;DELETE: &#39;</span> <span class="o">+</span> <span class="nx">sys</span><span class="p">.</span><span class="nx">inspect</span><span class="p">(</span><span class="nx">del</span><span class="p">));</span>
<span class="p">})</span>
<span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">resp</span><span class="p">){</span>
<span class="nx">sys</span><span class="p">.</span><span class="nx">puts</span><span class="p">(</span><span class="s1">&#39;wave goodbye...&#39;</span> <span class="o">+</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">);</span>
<span class="p">})</span>
<span class="p">.</span><span class="nx">stream</span><span class="p">();</span>
</code></pre>
</div>

<p style="text-align: justify;">Au début du code on instancie quelques variables, dont la variable config que l'on passera à notre objet twitter-node. Elle contient les accès Twitter, le fait que l'on veut utiliser l'API Twitter en mode filtre et le mot sur lequel on veut filter. On instancie aussi un serveur Node.js, dans mon cas sur le port 8080.</p>
<p style="text-align: justify;">On attache un objet socket.io sur notre serveur et on instancie un objet twitter-node. On démarre le stream de Twitter en attachant des fonctions aux évènements que l'on peut recevoir.</p>
<p style="text-align: justify;">L'évènement du nom de “ tweet ” est appelé à chaque fois que l'on reçoit <strong>un</strong> tweet. Les évènements limit et delete sont envoyés par l'API Twitter. Par exemple le cas du delete est important à prendre en compte si on construit un client Twitter sur l'API de streaming. Imaginons que quelqu'un poste un tweet et l'efface 2s après. Vous l'aurez déjà reçu et affiché. Mais 2s après vous allez recevoir un signal DELETE sur ce tweet et votre client pourra gérer sa disparition.</p>
<p style="text-align: justify;">Quand on passe dans l'évènement Tweet, je demande à Socket.io d'envoyer en <em>broadcast</em> (à toutes les personnes connectées sur mon serveur) d'envoyer un objet JSON du tweet reçu.</p>

<h1 style="text-align: justify;">Côté Client</h1>
<div class="highlight"><pre><code class="html"><span class="cp">&lt;!DOCTYPE HTML&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;title&gt;</span>Twitter live stream : NodeJS + Socket.io<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;ul&gt;&lt;/ul&gt;</span>
<span class="nt">&lt;script&gt;</span>
<span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nb">document</span><span class="p">,</span> <span class="nb">window</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
<span class="kd">var</span> <span class="nx">script</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;script&quot;</span><span class="p">);</span>
<span class="nx">script</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="s2">&quot;http://code.jquery.com/jquery.min.js&quot;</span><span class="p">;</span>
<span class="nx">script</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<span class="nx">$</span><span class="p">.</span><span class="nx">getScript</span><span class="p">(</span><span class="s2">&quot;http://127.0.0.1:8080/socket.io/socket.io.js&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<span class="kd">var</span> <span class="nx">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Socket</span><span class="p">(</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;port&quot;</span><span class="o">:</span> <span class="mi">8080</span><span class="p">});</span>
<span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">json</span><span class="p">)</span> <span class="p">{</span>
<span class="nx">data</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">json</span><span class="p">);</span>
<span class="nx">$</span><span class="p">(</span><span class="s2">&quot;&lt;li&gt;&lt;/li&gt;&quot;</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="s2">&quot;@&quot;</span> <span class="o">+</span> <span class="nx">data</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">screen_name</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">data</span><span class="p">.</span><span class="nx">text</span><span class="p">).</span><span class="nx">prependTo</span><span class="p">(</span><span class="s2">&quot;ul&quot;</span><span class="p">)</span>
<span class="p">});</span>
<span class="nx">socket</span><span class="p">.</span><span class="nx">connect</span><span class="p">();</span>
<span class="p">});</span>
<span class="p">};</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s2">&quot;head&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">script</span><span class="p">);</span>
<span class="p">})(</span><span class="nb">document</span><span class="p">,</span> <span class="nb">window</span><span class="p">);</span>
<span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre>
</div>

<p style="text-align: justify;">Donc là je charge jQuery et une fois que c'est fait je vais chercher le script socket.io.js. Il est automatiquement fournit par le serveur node, donc tu as peut-être le port à changer. Une fois que c'est fait on peut créer un nouveau socket et attacher une fonction à l'évènement <strong>message</strong>. Cet évènement est appelé à chaque fois que le serveur nous envoi quelque chose. Dans notre cas un tweet, donc je l'affiche.</p>

<h1 style="text-align: justify;">Lancement du serveur</h1>
<div class="highlight"><pre><code class="sh">node serveur.js
</code></pre>
</div>

<p style="text-align: justify;">Tu n'as plus qu'a ouvrir la partie cliente dans ton navigateur et ça devrait marcher. Je trouve Node.js vraiment intéressant et je n'avais pas pris le temps de le creuser plus que ça. Mais le développement de ce programme est vraiment rapide et s'améliore de jour en jour. Il existe des wrappers node pour Mysql, mongodb et d'autres base de données. Et d'autres plugins aussi utiles que Twitter-node ou socket.io. Il y a même des frameworks de type MVC et cie. On en trouve une bonne liste sur <a href="https://github.com/joyent/node/wiki/modules" target="_blank">cette page</a>.</p>

			</div>
			<footer class="share">
			<a href="http://twitter.com/share" class="twitter-share-button" data-text="Streaming Twitter: NodeJS & Socket.IO" data-count="horizontal" data-via="phollow" data-lang="fr">Tweet</a>
			</footer>
		</article>
    	<hr>
		  <div id="disqus_thread"></div>
		  <script>
		      var disqus_shortname = 'phollowfr';
		      var disqus_identifier = 'http://phollow.fr/2011/05/streaming-twitter-nodejs-socket-io/';
		      var disqus_url = 'http://phollow.fr/2011/05/streaming-twitter-nodejs-socket-io/';
		      
		      (function() {
		          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		          dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
		          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
		      })();
		  </script>
</div>


<footer id="footer" role="contentinfo" class="sixteen columns">
  <nav role="navigation">
    <ul>
      <li><a href="/">Homepage</a></li>
      <li><a href="http://twitter.com/phollow">Twitter</a></li>
      <li><a href="https://www.facebook.com/Phollow.fr">Facebook</a></li>
      <li><a href="http://dribbble.com/phollow">Dribbble</a></li>
      <li><a href="mailto:rydgel@phollow.fr">Contact</a></li>
    </ul>
  </nav>    
  <span class="copyright">Copyright © 2011 <a rel="author" href="https://plus.google.com/113221045987282389062?rel=author" title="Jérôme Mahuet">+Jérôme Mahuet</a> All Rights Reserved. Hosted by <a href="http://www.rackspace.com/">Rackspace US, Inc.</a></span>
<a title="Phollow.me" class="footer-logo-link" href="http://phollow.fr"><img src="/images/phollow-logo-footer.png" alt="Phollow.me"></a>
</footer>

</div><!-- container -->
<script src="/js/compiled/global.js?v=2"></script>

<!--[if (lt IE 9) & (!IEMobile)]>
<script src="/js/compiled/DOMAssistantCompressed-2.8.js"></script>
<script src="/js/compiled/selectivizr-1.0.1.js"></script>
<script src="/js/compiled/respond.min.js"></script>
<![endif]-->

<script>
      (function(){
        var twitterWidgets = document.createElement('script');
        twitterWidgets.type = 'text/javascript';
        twitterWidgets.async = true;
        twitterWidgets.src = '//platform.twitter.com/widgets.js';
        document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
      })();
</script>

<script type="text/javascript">
  var _gauges = _gauges || [];
  (function() {
    var t   = document.createElement('script');
    t.type  = 'text/javascript';
    t.async = true;
    t.id    = 'gauges-tracker';
    t.setAttribute('data-site-id', '4ec64821f5a1f55c33000003');
    t.src = '//secure.gaug.es/track.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(t, s);
  })();
</script>
</body>
</html>

 